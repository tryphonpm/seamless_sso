<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    
    <!-- Configuration de l'authentification Windows -->
    <security>
      <authentication>
        <windowsAuthentication enabled="true">
          <providers>
            <clear />
            <add value="Negotiate" />
            <add value="NTLM" />
          </providers>
        </windowsAuthentication>
        <anonymousAuthentication enabled="true" />
      </authentication>
      
      <!-- Configuration des autorisations -->
      <authorization>
        <add accessType="Allow" users="*" />
      </authorization>
    </security>
    
    <!-- Configuration des en-têtes HTTP -->
    <httpProtocol>
      <customHeaders>
        <add name="Access-Control-Allow-Credentials" value="true" />
        <add name="Access-Control-Allow-Headers" value="Authorization, Content-Type, Accept, Origin" />
        <add name="Access-Control-Allow-Methods" value="GET, POST, PUT, DELETE, OPTIONS" />
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
      </customHeaders>
    </httpProtocol>
    
    <!-- Gestion des erreurs -->
    <httpErrors errorMode="Detailed" />
    
    <!-- Configuration des handlers -->
    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
      <add name="StaticFile" path="*" verb="*" modules="StaticFileModule,DefaultDocumentModule,DirectoryListingModule" resourceType="Either" requireAccess="Read" />
    </handlers>
    
    <!-- Configuration de la réécriture d'URL -->
    <rewrite>
      <rules>
        <!-- Règle pour les fichiers statiques -->
        <rule name="StaticContent" stopProcessing="true">
          <match url="^(.+\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot))$" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="None" />
        </rule>
        
        <!-- Règle pour l'API d'authentification Windows -->
        <rule name="WindowsAuthAPI" stopProcessing="false">
          <match url="^api/auth/windows-auth" />
          <conditions>
            <add input="{REQUEST_METHOD}" pattern="GET" />
          </conditions>
          <action type="Rewrite" url="server.js" />
          <serverVariables>
            <set name="HTTP_X_WINDOWS_AUTH" value="true" />
          </serverVariables>
        </rule>
        
        <!-- Règle générale pour Node.js -->
        <rule name="DynamicContent">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>
    
    <!-- Configuration iisnode -->
    <iisnode 
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
      interceptor="&quot;%programfiles%\iisnode\interceptor.js&quot;"
      watchedFiles="web.config;*.js;routes\*.js"
      loggingEnabled="true"
      logDirectory="logs"
      debuggingEnabled="false"
      devErrorsEnabled="false"
      flushResponse="false"
      enableXFF="true" />
      
    <!-- Configuration de la compression -->
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />
    
    <!-- Configuration du cache statique -->
    <staticContent>
      <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="7.00:00:00" />
      
      <!-- MIME Types pour les fonts et assets modernes -->
      <mimeMap fileExtension=".woff" mimeType="font/woff" />
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
    </staticContent>
    
    <!-- Configuration de sécurité supplémentaire -->
    <httpProtocol>
      <customHeaders>
        <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains" />
        <add name="Content-Security-Policy" value="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self'" />
      </customHeaders>
    </httpProtocol>
    
  </system.webServer>
  
  <!-- Configuration spécifique pour l'authentification Windows -->
  <location path="api/auth/windows-auth">
    <system.webServer>
      <security>
        <authentication>
          <windowsAuthentication enabled="true" />
          <anonymousAuthentication enabled="false" />
        </authentication>
      </security>
    </system.webServer>
  </location>
  
  <!-- Configuration pour les assets statiques (pas d'auth requise) -->
  <location path="_nuxt">
    <system.webServer>
      <security>
        <authentication>
          <windowsAuthentication enabled="false" />
          <anonymousAuthentication enabled="true" />
        </authentication>
      </security>
    </system.webServer>
  </location>
  
</configuration>